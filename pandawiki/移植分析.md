# PandaWiki 移植分析

## 项目概述

PandaWiki 是一个基于知识图谱的智能文档管理系统，原始配置使用 docker-compose 部署，包含多个微服务组件。本文档记录了从 docker-compose.yml 移植到懒猫应用平台的详细分析和实施过程。

## 原始架构分析

### 服务组件（共10个服务）

1. **caddy** - 反向代理服务器（使用 network_mode: host）
2. **nginx** - Web服务器，暴露管理端口 ${ADMIN_PORT}:8080
3. **app** - 前端应用服务
4. **api** - 后端API服务
5. **consumer** - 消息消费者服务
6. **postgres** - PostgreSQL数据库
7. **redis** - Redis缓存
8. **minio** - 对象存储服务
9. **nats** - 消息队列服务
10. **qdrant** - 向量数据库
11. **crawler** - 爬虫服务（使用 anydoc 镜像）
12. **raglite** - RAG处理服务

### 网络配置

- 使用自定义网络 `panda-wiki` 
- 子网配置：`${SUBNET_PREFIX:-169.254.15}.0/24`
- 每个服务分配固定IP地址

### 数据持久化

- postgres: `./data/postgres:/var/lib/postgresql/data`
- redis: `./data/redis:/data`
- minio: `./data/minio:/data`
- nats: `./data/nats:/data`
- qdrant: `./data/qdrant:/qdrant/storage`
- raglite: `./data/raglite:/data`
- nginx: `./data/nginx/ssl:/etc/nginx/ssl`
- caddy: 多个配置和数据目录

### 环境变量依赖

- NATS_PASSWORD
- POSTGRES_PASSWORD  
- REDIS_PASSWORD
- S3_SECRET_KEY
- JWT_SECRET
- ADMIN_PASSWORD
- SUBNET_PREFIX
- QDRANT_API_KEY

## 移植策略

### 1. 服务简化和映射

#### 移除的服务
- **caddy**: 使用 `network_mode: host`，懒猫平台不支持，功能由平台的 application 容器替代

#### 保留的服务（11个）
- nginx → nginx
- app → app  
- api → api
- consumer → consumer
- postgres → postgres
- redis → redis
- minio → minio
- nats → nats
- qdrant → qdrant
- crawler → crawler
- raglite → raglite

### 2. 路由配置转换

#### 原始路由（通过 caddy + nginx）
- caddy 作为入口点（network_mode: host）
- nginx 暴露管理端口

#### 懒猫平台路由
```yaml
application:
  routes:
    - /=http://nginx:8080
```

### 3. 镜像同步

所有镜像从 `chaitin-registry.cn-hangzhou.cr.aliyuncs.com` 同步到 `registry.lazycat.cloud`：

1. `chaitin/panda-wiki-nginx:v3.47.1`
2. `chaitin/panda-wiki-app:v3.47.1`  
3. `chaitin/panda-wiki-api:v3.47.1`
4. `chaitin/panda-wiki-consumer:v3.47.1`
5. `chaitin/panda-wiki-postgres:17.5`
6. `chaitin/panda-wiki-redis:7.4.2-alpine`
7. `chaitin/panda-wiki-minio:RELEASE.2025-04-22T22-12-26Z-cpuv1`
8. `chaitin/panda-wiki-nats:2.11.3-alpine`
9. `chaitin/panda-wiki-qdrant:v1.14.1`
10. `chaitin/anydoc:v0.6.11`
11. `chaitin/panda-wiki-raglite:1-4-1`

### 4. 环境变量适配

#### 硬编码默认值
- POSTGRES_PASSWORD: `pandawiki123`
- REDIS_PASSWORD: `pandawiki456`  
- NATS_PASSWORD: `pandawiki789`
- S3_SECRET_KEY: `pandawikiminio123`
- JWT_SECRET: `pandawikijwt456`
- ADMIN_PASSWORD: `admin123`
- QDRANT_API_KEY: `pandawikiqdrant789`

#### 服务间通信URL适配
- 原始：使用容器名（如 `panda-wiki-postgres`）
- 懒猫：使用简化服务名（如 `postgres`）

### 5. 数据持久化转换

```yaml
# 原始 volumes → 懒猫 binds
./data/postgres → /lzcapp/var/postgres
./data/redis → /lzcapp/var/redis  
./data/minio → /lzcapp/var/minio
./data/nats → /lzcapp/var/nats
./data/qdrant → /lzcapp/var/qdrant
./data/raglite → /lzcapp/var/raglite
./data/nginx/ssl → /lzcapp/var/nginx_ssl
./data/conf/api → /lzcapp/var/api_conf
```

### 6. 健康检查配置

#### postgres
```yaml
health_check:
  test: ["CMD-SHELL", "pg_isready", "-U", "panda-wiki", "-h", "localhost"]
  start_period: 180s
```

#### 其他关键服务
- api, nginx: start_period 40-60s
- 数据库相关服务: start_period 180s

### 7. 依赖关系保留

```yaml
api:
  depends_on:
    - postgres
    - nats  
    - raglite

consumer:
  depends_on:
    - nats
    - api
    - raglite

raglite:
  depends_on:
    - postgres
    - minio
    - qdrant
```

## 技术难点和解决方案

### 1. network_mode: host 问题
**问题**: caddy 服务使用 network_mode: host，懒猫平台不支持
**解决**: 移除 caddy 服务，由懒猫平台的 application 容器处理路由

### 2. 固定IP地址分配
**问题**: 原配置为每个服务分配固定IP
**解决**: 移除IP配置，使用Docker默认网络和服务发现

### 3. 环境变量管理
**问题**: 原配置依赖多个环境变量
**解决**: 硬编码默认值，简化部署流程

### 4. 端口暴露策略
**问题**: nginx 暴露管理端口 ${ADMIN_PORT}:8080
**解决**: 通过 application.routes 配置访问路径

## 移植检查清单

- [x] 服务架构分析完成
- [x] 路由策略确定
- [x] 镜像同步计划制定
- [x] 环境变量适配方案确定
- [x] 数据持久化方案设计
- [x] 健康检查配置规划
- [x] 依赖关系梳理完成
- [ ] 镜像同步执行
- [ ] lzc-manifest.yml 配置
- [ ] lzc-build.yml 配置
- [ ] 配置验证和测试

## 预期效果

移植完成后，PandaWiki 将：
1. 完全兼容懒猫应用平台
2. 保持原有功能完整性
3. 简化部署和管理流程
4. 提供统一的访问入口
5. 支持数据持久化和备份

## 注意事项

1. **数据迁移**: 如果从现有部署迁移，需要注意数据目录路径变更
2. **性能优化**: 移除固定IP后，需要验证服务间通信性能
3. **安全配置**: 硬编码密码仅适用于测试环境，生产环境需要修改
4. **监控告警**: 需要配置适当的健康检查和监控
5. **扩展性**: 当前配置为单实例部署，后续可考虑多实例支持
