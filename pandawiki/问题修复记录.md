# PandaWiki 启动问题修复记录

## 发现的问题

### 1. 数据库连接问题
- **raglite 服务**: 尝试连接到不存在的 `raglite` 数据库
- **api 服务**: 无法解析 `panda-wiki-postgres` 主机名

### 2. 服务名解析问题  
- **nginx**: 配置中仍使用原始服务名 `panda-wiki-api:8000`
- **consumer**: 尝试连接到 `169.254.15.13:4222` (原始固定IP)

### 3. 服务依赖和启动顺序问题
- **crawler**: 无法连接到 minio 服务 (connection refused)
- 缺少适当的健康检查和启动等待时间

## 修复措施

### 1. 数据库配置修复
- 添加独立的 `db-init` 服务来创建 raglite 数据库
- 为所有服务添加明确的数据库连接环境变量:
  - `POSTGRES_HOST=postgres`
  - `POSTGRES_PORT=5432`
  - `POSTGRES_USER=panda-wiki`
  - `POSTGRES_DB=panda-wiki`
- 将 postgres 健康检查的 `start_period` 设置为 180s

### 2. 服务连接配置修复
- 为 api 和 consumer 服务添加完整的服务连接环境变量
- 添加 NATS 连接配置:
  - `NATS_HOST=nats`
  - `NATS_PORT=4222`
  - `NATS_USER=panda-wiki`
- 添加 Redis 连接配置:
  - `REDIS_HOST=redis`
  - `REDIS_PORT=6379`
- 添加 S3/MinIO 连接配置:
  - `S3_ENDPOINT=minio:9000`
  - `S3_ACCESS_KEY=s3panda-wiki`

### 3. MinIO 配置修复
- 将 `MINIO_ACCESS_KEY` 改为 `MINIO_ROOT_USER`
- 将 `MINIO_SECRET_KEY` 改为 `MINIO_ROOT_PASSWORD`
- 添加 MinIO 健康检查

### 4. 服务依赖关系优化
- 添加 `db-init` 服务来确保数据库正确初始化
- raglite 依赖于 `db-init` 而不是直接依赖 postgres
- api 和 consumer 依赖于基础服务 (postgres, redis, nats, minio)
- 为 crawler 添加对 nats 和 minio 的依赖
- 为 nginx 添加对 api 和 frontend 的依赖

### 5. 健康检查配置
- **postgres**: `start_period: 180s` (数据库初始化需要时间)
- **minio**: `start_period: 60s` 
- **nats**: `start_period: 30s`
- **redis**: `start_period: 30s`
- **qdrant**: `start_period: 60s`
- **crawler**: `start_period: 90s`
- **nginx**: `start_period: 60s`
- **api**: `start_period: 60s`
- **raglite**: `start_period: 60s`

### 6. 环境变量补充
- 为 crawler 添加 `OSS_MINIO_BUCKET=anydoc`
- 为 raglite 添加 `DATABASE_NAME=panda-wiki`

## 预期效果

修复后的配置应该能够:
1. 正确创建和连接数据库
2. 服务间正常通信
3. 按正确顺序启动服务
4. 通过健康检查确保服务就绪

## 验证步骤

1. 检查 postgres 是否成功创建了 `panda-wiki` 和 `raglite` 两个数据库
2. 验证 raglite 能否成功连接到 postgres
3. 确认 api 服务能否正常启动并连接数据库
4. 检查 nginx 是否能正确代理到 api 和 frontend 服务
5. 验证 crawler 能否连接到 minio 和 nats 服务
6. 确认所有服务的健康检查都能通过

## 注意事项

- 首次启动可能需要较长时间，特别是数据库初始化
- 如果仍有问题，可能需要检查具体的 nginx 配置文件是否支持环境变量替换
- 某些服务可能需要特定的初始化脚本来处理配置文件的动态生成
