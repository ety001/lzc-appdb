# PandaWiki 服务配置分析

## 问题诊断

### 当前状态
- ✅ db-init: 成功创建 raglite 数据库
- ✅ raglite: 数据库连接成功，MinIO 连接成功
- ❌ api: 仍在寻找 `panda-wiki-postgres`
- ❌ consumer: 仍在使用硬编码 IP `169.254.15.13:4222`
- ❌ nginx: 仍在寻找 `panda-wiki-api:8000`
- ❌ raglite: 无法连接到 qdrant

## 根本原因分析

### 1. API 服务问题
API 服务仍在寻找 `panda-wiki-postgres`，说明：
- 服务内部可能有硬编码的主机名
- 或者环境变量没有正确传递到应用程序

### 2. Consumer 服务问题
Consumer 使用固定 IP `169.254.15.13:4222`，说明：
- 服务内部有硬编码的 NATS 地址
- 环境变量配置没有生效

### 3. Nginx 配置问题
Nginx 寻找 `panda-wiki-api:8000`，说明：
- nginx 配置文件中硬编码了服务名
- 环境变量替换没有生效

## 解决方案

### 方案1: 使用原始服务名
保持与原始 docker-compose.yml 一致的服务名：

```yaml
services:
  panda-wiki-nginx:  # 改回原名
  panda-wiki-app:    # 改回原名
  panda-wiki-api:    # 改回原名
  # ... 其他服务
```

### 方案2: 修改镜像配置
如果镜像支持环境变量配置，添加相应的环境变量：

```yaml
api:
  environment:
    - DATABASE_HOST=postgres
    - DATABASE_URL=postgresql://panda-wiki:pandawiki123@postgres:5432/panda-wiki

consumer:
  environment:
    - NATS_URL=nats://panda-wiki:pandawiki789@nats:4222
```

### 方案3: 网络别名
为服务添加网络别名以保持兼容性：

```yaml
services:
  postgres:
    networks:
      default:
        aliases:
          - panda-wiki-postgres
  
  nats:
    networks:
      default:
        aliases:
          - panda-wiki-nats
```

## 推荐解决方案

考虑到镜像可能有内部硬编码配置，**推荐使用方案1**：
恢复原始服务名，确保与镜像内部配置兼容。

## 立即行动

1. 将服务名改回原始名称
2. 更新服务间的依赖关系
3. 确保路由配置指向正确的服务名
4. 测试服务间连接
