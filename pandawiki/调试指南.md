# PandaWiki 调试指南

## 当前问题分析

### 容器状态
- **postgres**: 已退出 (ExitCode: 0) - 正常退出
- **minio**: 已退出 (ExitCode: 0) - 正常退出
- **健康检查**: 两个容器都显示 unhealthy，但 postgres 的健康检查实际是通过的

### 可能原因
1. **依赖服务启动失败**: 其他服务（如 api, consumer）启动失败导致整个应用停止
2. **db-init 服务问题**: 数据库初始化服务可能有问题
3. **资源限制**: 可能触发了内存或其他资源限制

## 调试步骤

### 1. 检查所有容器状态
```bash
docker ps -a --filter "name=pandawiki"
```

### 2. 查看容器日志
```bash
# 查看 postgres 日志
docker logs inkakawaety001pandawiki-postgres-1

# 查看 minio 日志  
docker logs inkakawaety001pandawiki-minio-1

# 查看 db-init 日志
docker logs inkakawaety001pandawiki-db-init-1

# 查看 api 日志
docker logs inkakawaety001pandawiki-api-1
```

### 3. 检查网络连接
```bash
# 检查网络
docker network ls | grep pandawiki
docker network inspect inkakawaety001pandawiki_default
```

### 4. 手动测试数据库连接
```bash
# 进入 postgres 容器测试
docker exec -it inkakawaety001pandawiki-postgres-1 psql -U panda-wiki -d panda-wiki -c "\\l"
```

### 5. 检查资源使用情况
```bash
# 检查系统资源
docker stats --no-stream
df -h  # 检查磁盘空间
free -h  # 检查内存
```

## 可能的修复方案

### 方案1: 简化配置
移除 db-init 服务，直接在 raglite 中处理数据库创建：

```yaml
raglite:
  environment:
    - DATABASE_NAME=panda-wiki  # 使用现有数据库
```

### 方案2: 修复 db-init 服务
确保 db-init 服务正确执行并退出：

```yaml
db-init:
  restart: "no"  # 确保只运行一次
  command: >
    bash -c "
    until pg_isready -h postgres -U panda-wiki; do sleep 2; done &&
    psql -h postgres -U panda-wiki -d panda-wiki -c 'CREATE DATABASE IF NOT EXISTS raglite;' &&
    echo 'Database initialization completed'
    "
```

### 方案3: 检查启动顺序
确保服务按正确顺序启动，增加重启策略：

```yaml
services:
  postgres:
    restart: unless-stopped
  minio:
    restart: unless-stopped
```

## 立即行动建议

1. **查看完整日志**: 获取所有服务的启动日志
2. **检查 db-init**: 确认数据库初始化是否成功
3. **简化测试**: 先只启动基础服务（postgres, redis, minio）
4. **逐步添加**: 确认基础服务稳定后，逐步添加应用服务

## 常见问题排查

### 数据库连接问题
- 确认 postgres 容器正在运行
- 检查数据库用户和密码是否正确
- 验证网络连接是否正常

### 存储问题
- 检查 minio 数据目录权限
- 确认存储空间充足
- 验证 minio 配置是否正确

### 内存问题
- 检查系统可用内存
- 确认没有内存泄漏
- 考虑调整容器内存限制
