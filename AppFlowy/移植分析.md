# AppFlowy 移植分析文档

## 一、服务分析

### 原始 docker-compose.yml 中的服务

#### 1. nginx
- **作用**: 反向代理服务器，处理所有外部请求的路由分发
- **配置**: 
  - 监听 80 和 443 端口
  - 使用 SSL 证书
  - 配置了多个 location 规则，将请求转发到不同后端服务
- **路由规则**:
  - `/gotrue/` → gotrue:9999
  - `/ws` → appflowy_cloud:8000 (WebSocket)
  - `/api` → appflowy_cloud:8000
  - `/minio/` → minio:9001 (Web UI)
  - `/minio-api/` → minio:9000 (API)
  - `/pgadmin/` → pgadmin:80
  - `/console` → admin_frontend:3000
  - `/` → appflowy_web:80

#### 2. minio
- **作用**: 对象存储服务，用于文件存储
- **配置**:
  - 使用 minio/minio 镜像
  - 控制台端口: 9001
  - API 端口: 9000
  - 数据持久化到 minio_data volume
- **环境变量**:
  - MINIO_BROWSER_REDIRECT_URL: 浏览器重定向 URL
  - MINIO_ROOT_USER/PASSWORD: 管理员凭据

#### 3. postgres
- **作用**: PostgreSQL 数据库，使用 pgvector 扩展
- **配置**:
  - 镜像: pgvector/pgvector:pg16
  - 数据持久化到 postgres_data volume
  - 健康检查: pg_isready
- **环境变量**:
  - POSTGRES_USER, POSTGRES_DB, POSTGRES_PASSWORD

#### 4. redis
- **作用**: 缓存和消息队列服务
- **配置**: 使用官方 redis 镜像，无特殊配置

#### 5. gotrue
- **作用**: 认证服务，处理用户登录、注册、JWT 令牌等
- **配置**:
  - 端口: 9999
  - 依赖 postgres 数据库
  - 健康检查: curl /health
- **环境变量**:
  - 大量认证相关配置（OAuth、SAML、SMTP 等）
  - DATABASE_URL: 连接 postgres 数据库

#### 6. appflowy_cloud
- **作用**: 核心应用服务，提供 API 和 WebSocket 服务
- **配置**:
  - 端口: 8000
  - 依赖 gotrue
  - 健康检查: curl /api/health
- **环境变量**:
  - 数据库连接、Redis 连接、S3 配置、AI 服务配置等

#### 7. admin_frontend
- **作用**: 管理后台前端界面
- **配置**:
  - 端口: 3000
  - 依赖 gotrue 和 appflowy_cloud
- **环境变量**:
  - APPFLOWY_GOTRUE_BASE_URL
  - APPFLOWY_BASE_URL

#### 8. ai
- **作用**: AI 服务，提供 AI 功能
- **配置**:
  - 端口: 5001
  - 依赖 postgres 和 appflowy_cloud
  - 健康检查: curl /health
- **环境变量**:
  - OpenAI/Azure OpenAI 配置
  - 数据库和 Redis 连接
  - MinIO 配置

#### 9. appflowy_worker
- **作用**: 后台任务处理服务
- **配置**:
  - 依赖 postgres 和 appflowy_cloud
- **环境变量**:
  - 数据库连接、Redis 连接、S3 配置、邮件服务配置

#### 10. appflowy_web
- **作用**: Web 前端应用
- **配置**:
  - 端口: 80
  - 依赖 appflowy_cloud
- **环境变量**:
  - APPFLOWY_BASE_URL
  - APPFLOWY_GOTRUE_BASE_URL
  - APPFLOWY_WS_BASE_URL (WebSocket)

## 二、服务映射关系

### 移植后的 lzc-manifest.yml 服务映射

| 原始服务 | 移植后服务 | 映射关系 | 说明 |
|---------|-----------|---------|------|
| nginx | - | **移除** | 由懒猫平台的 application.routes 替代 |
| minio | minio | **保留** | 配置基本一致 |
| postgres | timescaledb | **替换** | 使用 timescaledb 替代 postgres（可能因为需要时序数据库功能） |
| redis | redis | **保留** | 配置基本一致 |
| gotrue | gotrue | **保留** | 配置基本一致，但简化了部分环境变量 |
| appflowy_cloud | appflowy | **重命名** | 服务名简化 |
| admin_frontend | - | **移除** | 未包含在移植版本中 |
| ai | ai | **保留** | 配置基本一致，但简化了部分环境变量 |
| appflowy_worker | worker | **重命名** | 服务名简化 |
| appflowy_web | web | **重命名** | 服务名简化 |

## 三、路由配置转换

### 访问入口说明

#### application 项的特殊性

在懒猫应用配置文件中，`application` 项是一个特殊的容器，里面运行了 nginx 服务。这个容器负责处理所有外部请求的路由分发。

**关键点**:
- `application` 容器由懒猫平台自动管理
- 内部运行 nginx，负责反向代理和路由分发
- 不需要单独配置 nginx 容器

#### 路由配置的两种方式

懒猫平台提供了两种方式来实现流量路由：

##### 方式一：使用 application.routes 配置（推荐）

**特点**:
- 简单直接，配置在 `lzc-manifest.yml` 的 `application.routes` 中
- 懒猫平台会自动处理路由转发
- 对于根路径，只需要配置 `/=http://service:80` 即可

**配置格式**:
```yaml
application:
  routes:
    - /=http://web:80
    - /api/=http://appflowy:8000/api/
    - /gotrue/=http://gotrue:9999/
```

**语法说明**:
- 路由配置格式为：`- /path/=http://service:port/path/`
- 对于根路径 `/`，格式为：`- /=http://service:port`
- 必须使用完整的 URL 格式，包括 `http://` 协议
- 路径和 URL 之间使用 `=` 连接

**注意事项**:
- 如果使用 routes 方式，只需要关注 80 端口的普通访问即可
- 懒猫平台有自签名服务，不需要额外配置证书
- 对于根路径 `/`，使用 `/=http://service:80` 格式（注意是完整的 URL）

##### 方式二：使用自定义 nginx 配置替换

**特点**:
- 可以完全自定义 nginx 配置
- 适合复杂的路由需求
- 需要提供自定义的 nginx.conf 配置文件

**使用方法**:
- 参考懒猫文档（`.docs`）了解如何替换容器内原有的配置
- 将自定义的 nginx.conf 放在应用目录中
- 在构建配置中指定替换路径

**适用场景**:
- 需要复杂的 nginx 配置（如特殊 header、rewrite 规则等）
- 需要自定义 SSL 配置（虽然懒猫有自签名服务）
- 需要特殊的代理设置

### nginx 配置 → application.routes

#### 转换规则

对于 AppFlowy 这种原本使用 nginx 作为反向代理的应用，通常使用方式一（routes 配置）即可。

**转换格式**: nginx 的 location 规则转换为懒猫平台的 routes 配置，格式为：`- /path/=http://service:port/path/`

**语法规则**:
- 路由配置必须使用完整的 URL 格式，包括 `http://` 协议
- 对于根路径 `/`，格式为：`- /=http://service:port`
- 路径和 URL 之间使用 `=` 连接
- 懒猫平台会自动处理路径前缀匹配
- 不需要显式的 rewrite 规则

#### AppFlowy 具体转换示例

1. **`/gotrue/` → gotrue:9999**
   - 原始 nginx: `location /gotrue/ { proxy_pass http://gotrue:9999; rewrite ^/gotrue(/.*)$ $1 break; }`
   - 转换后: `- /gotrue/=http://gotrue:9999/`
   - 说明: 懒猫平台的路由会自动处理路径前缀，不需要显式的 rewrite 规则

2. **`/api` → appflowy_cloud:8000**
   - 原始 nginx: `location /api { proxy_pass http://appflowy_cloud:8000; }`
   - 转换后: `- /api/=http://appflowy:8000/api/`
   - 注意：服务名从 `appflowy_cloud` 改为 `appflowy`

3. **`/minio/` → minio:9000**
   - 原始 nginx: `location /minio/ { proxy_pass http://minio:9001; }`
   - 转换后: `- /minio/=http://minio:9000/minio/`
   - 注意：nginx 中 minio Web UI 使用 9001 端口，但懒猫版本使用 9000 端口

4. **`/` → appflowy_web:80**
   - 原始 nginx: `location / { proxy_pass http://appflowy_web:80; }`
   - 转换后: `- /=http://web:80`
   - 说明: 对于根路径，可以直接使用 `/=service:80` 格式，这是最简单的配置方式
   - 注意：服务名从 `appflowy_web` 改为 `web`

5. **`/ws` → appflowy_cloud:8000 (WebSocket)**
   - 原始 nginx: `location /ws { proxy_pass http://appflowy_cloud:8000; proxy_set_header Upgrade $http_upgrade; }`
   - 转换后: **未在 routes 中显式配置**
   - 说明: 可能由平台自动处理 WebSocket 升级，或通过 `/api` 路由处理

6. **`/console` → admin_frontend:3000**
   - 原始 nginx: `location /console { proxy_pass http://admin_frontend:3000; }`
   - 转换后: **未转换**，因为 admin_frontend 服务被移除了

#### 证书和 HTTPS 配置

**重要说明**:
- 懒猫平台有自签名服务，会自动处理 HTTPS 证书
- 在移植时只需要关注 80 端口的普通 HTTP 访问即可
- 不需要额外配置 SSL 证书或 443 端口
- 如果使用 `application.routes` 方式，平台会自动处理证书和 HTTPS 重定向

## 四、环境变量转换

### 服务间通信 URL

#### 原始配置（使用环境变量）
- `APPFLOWY_GOTRUE_BASE_URL=${APPFLOWY_GOTRUE_BASE_URL}` (外部 URL)
- `APPFLOWY_BASE_URL=${APPFLOWY_BASE_URL}` (外部 URL)

#### 移植后配置（硬编码服务名）
- `APPFLOWY_GOTRUE_BASE_URL=http://gotrue:9999` (服务间通信)
- `APPFLOWY_BASE_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp` (外部访问)

### 关键转换点

1. **服务间通信**: 使用服务名（如 `gotrue:9999`, `timescaledb:5432`）
2. **外部访问**: 使用完整域名（如 `appflowy.ink.akawa.ety001.appflowy.lzcapp`）
3. **数据库连接**: 
   - 原始: `postgres://postgres:password@postgres:5432/postgres`
   - 移植: `postgres://postgres:123456@timescaledb:5432/postgres`
   - 注意：服务名从 `postgres` 改为 `timescaledb`，密码硬编码为 `123456`

4. **Redis 连接**:
   - 原始: `redis://redis:6379` (使用环境变量)
   - 移植: `redis://redis:6379` (硬编码，保持一致)

5. **MinIO 连接**:
   - 原始: 使用环境变量 `${APPFLOWY_S3_MINIO_URL}`
   - 移植: `http://minio:9000` (硬编码服务名)

6. **Web URL**:
   - 原始: `${APPFLOWY_WEB_URL}` (环境变量)
   - 移植: `http://web:80` (硬编码服务名)

## 五、数据持久化转换

### docker-compose volumes → lzc-manifest binds

#### 持久化存储路径规范

懒猫平台要求所有需要持久化存储的数据必须挂载到 `/lzcapp/var/` 目录下，并遵循以下原则：

1. **按服务区分路径**:
   - 每个服务使用独立的挂载路径，格式为 `/lzcapp/var/服务名`
   - 例如：minio 服务挂载 `/lzcapp/var/minio` 到容器的指定目录

2. **多路径持久化**:
   - 如果一个容器有多个路径需要做持久化存储，路径格式为 `/lzcapp/var/容器名_服务名`
   - 例如：如果 appflowy 服务需要挂载配置和数据两个目录，可以使用：
     - `/lzcapp/var/appflowy_config:/config`
     - `/lzcapp/var/appflowy_data:/data`

3. **路径命名建议**:
   - 使用简短、清晰的服务名
   - 保持路径名称与服务名一致，便于管理

#### AppFlowy 实际转换示例

1. **postgres_data → timescaledb**:
   - 原始: `postgres_data:/var/lib/postgresql/data` (named volume)
   - 移植: `/lzcapp/var/pgdata:/var/lib/postgresql/data` (bind mount)
   - 说明: 使用 `pgdata` 作为路径名，表示 PostgreSQL 数据

2. **minio_data → minio**:
   - 原始: `minio_data:/data` (named volume)
   - 移植: `/lzcapp/var/minio:/data` (bind mount)
   - 说明: 使用服务名 `minio` 作为路径名

#### 注意事项

- 所有持久化数据必须挂载到 `/lzcapp/var/` 目录下
- 路径名称应该清晰反映服务用途
- 避免使用过于复杂的路径名称

## 六、健康检查转换

### docker-compose healthcheck → lzc-manifest health_check

1. **postgres**:
   - 原始: `test: [ "CMD", "pg_isready", "-U", "${POSTGRES_USER}", "-d", "${POSTGRES_DB}", "-p", "${POSTGRES_PORT:-5432}" ]`
   - 移植: `test: ["CMD-SHELL", "pg_isready", "-U", "postgres", "-h", "localhost"]`
   - 注意：格式从数组改为字符串，使用 `CMD-SHELL`

2. **gotrue**:
   - 原始: `test: "curl --fail http://127.0.0.1:9999/health || exit 1"`
   - 移植: 未配置（可能使用默认健康检查）

3. **appflowy_cloud**:
   - 原始: `test: "curl --fail http://127.0.0.1:8000/api/health || exit 1"`
   - 移植: 未配置

4. **ai**:
   - 原始: `test: [ "CMD", "curl", "-f", "http://localhost:5001/health" ]`
   - 移植: 未配置

## 七、依赖关系

### depends_on 配置

移植版本保留了关键的依赖关系：

1. **appflowy** 依赖: timescaledb, redis, minio, gotrue
2. **gotrue** 依赖: timescaledb
3. **worker** 依赖: timescaledb, redis, minio
4. **web** 依赖: appflowy
5. **ai** 依赖: timescaledb, redis, minio

## 八、发现的问题和改进点

### 1. admin_frontend 服务缺失
- **问题**: 原始配置中有 admin_frontend 服务，提供管理后台功能，但移植版本中未包含
- **影响**: 用户无法访问管理后台（`/console` 路由）
- **建议**: 如果需要管理功能，应该添加 admin_frontend 服务

### 2. WebSocket 路由未显式配置
- **问题**: nginx 中配置了 `/ws` 路由用于 WebSocket，但移植版本的 routes 中未显式配置
- **影响**: 可能影响 WebSocket 连接
- **建议**: 检查是否需要添加 WebSocket 路由配置，或确认平台是否自动处理

### 3. 环境变量硬编码
- **问题**: 移植版本中很多环境变量被硬编码（如密码 `123456`），而不是使用环境变量
- **影响**: 安全性降低，配置不够灵活
- **建议**: 考虑使用懒猫平台的环境变量机制（如 `${LAZYCAT_APP_DOMAIN}`）

### 4. 健康检查配置缺失
- **问题**: 移植版本中大部分服务的健康检查配置被移除
- **影响**: 可能影响服务启动顺序和健康监控
- **建议**: 添加关键服务的健康检查配置

### 5. 数据库镜像替换
- **问题**: 从 postgres (pgvector) 替换为 timescaledb
- **影响**: 需要确认 timescaledb 是否支持 pgvector 扩展，以及是否真的需要时序数据库功能
- **建议**: 如果不需要时序数据库功能，可以考虑继续使用 postgres

### 6. MinIO 端口配置
- **问题**: nginx 配置中 minio Web UI 使用 9001 端口，但移植版本中可能使用 9000
- **影响**: 需要确认 MinIO 的实际端口配置
- **建议**: 检查 MinIO 服务的实际端口配置

## 九、路由配置详细分析

### nginx location 规则详解

#### 1. `/gotrue/` 路由
```nginx
location /gotrue/ {
    proxy_pass $gotrue_backend;
    rewrite ^/gotrue(/.*)$ $1 break;
    proxy_set_header Host $http_host;
    proxy_pass_request_headers on;
}
```
- **作用**: 将 `/gotrue/` 前缀的请求转发到 gotrue 服务
- **路径重写**: 使用 `rewrite` 规则去掉 `/gotrue` 前缀
- **转换后**: `- /gotrue/=http://gotrue:9999/`
- **说明**: 懒猫平台的路由配置会自动处理路径前缀，所以不需要显式的 rewrite

#### 2. `/ws` WebSocket 路由
```nginx
location /ws {
    proxy_pass $appflowy_cloud_backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_read_timeout 86400s;
}
```
- **作用**: WebSocket 连接路由
- **特殊配置**: 需要 Upgrade 和 Connection 头
- **转换后**: **未在 routes 中显式配置**
- **问题**: 可能通过 `/api` 路由处理，或需要单独配置 WebSocket 路由

#### 3. `/api` 路由
```nginx
location /api {
    proxy_pass $appflowy_cloud_backend;
    # 特殊处理 /api/workspace/.../publish (256M)
    # 特殊处理 /api/chat (流式响应)
    # 特殊处理 /api/import (2G)
}
```
- **作用**: API 请求路由，包含多个子路由的特殊处理
- **转换后**: `- /api/=http://appflowy:8000/api/`
- **说明**: 
  - 大文件上传的特殊处理（256M, 2G）可能需要平台层面支持
  - 流式响应（chat）可能需要平台支持 chunked transfer

#### 4. `/minio/` 路由
```nginx
location /minio/ {
    proxy_pass $minio_backend;  # minio:9001 (Web UI)
    rewrite ^/minio/(.*) /$1 break;
}
```
- **作用**: MinIO Web UI 访问
- **转换后**: `- /minio/=http://minio:9000/minio/`
- **注意**: 
  - nginx 中使用 9001 端口（控制台）
  - 移植版本使用 9000 端口，但配置了 `--console-address ":9001"`
  - 可能需要确认实际端口配置

#### 5. `/minio-api/` 路由
```nginx
location /minio-api/ {
    proxy_pass $minio_api_backend;  # minio:9000 (API)
    proxy_set_header Host $minio_internal_host;
    rewrite ^/minio-api/(.*) /$1 break;
    client_max_body_size 1000M;
}
```
- **作用**: MinIO API 访问（用于预签名 URL）
- **转换后**: **未在 routes 中配置**
- **问题**: 如果应用需要预签名 URL 功能，可能需要添加此路由

#### 6. `/console` 路由
```nginx
location /console {
    proxy_pass $admin_frontend_backend;  # admin_frontend:3000
}
```
- **作用**: 管理后台访问
- **转换后**: **未配置**（因为 admin_frontend 服务被移除）

#### 7. `/` 根路由
```nginx
location / {
    proxy_pass $appflowy_web_backend;  # appflowy_web:80
}
```
- **作用**: 前端应用访问
- **转换后**: `- /=http://web:80`
- **说明**: 这是默认路由，处理所有未匹配的请求。注意必须使用完整的 URL 格式 `http://service:port`

### 路由配置转换规则总结

1. **路径前缀匹配**: nginx 的 `location /path/` 转换为 `- /path/=http://service:port/path/`
2. **根路径配置**: 对于根路径 `/`，格式为 `/=http://service:port`（必须使用完整的 URL，包括 `http://` 协议）
3. **语法格式**: 路径和 URL 之间使用 `=` 连接，URL 必须包含协议（`http://` 或 `ws://`）
4. **路径重写**: nginx 的 `rewrite` 规则在懒猫平台中通常不需要，因为路由配置会自动处理路径前缀
4. **证书处理**: 懒猫平台有自签名服务，只需要配置 80 端口，不需要额外配置证书
5. **WebSocket**: 需要确认平台是否自动支持 WebSocket 升级，或需要单独配置
6. **大文件上传**: 需要确认平台是否支持大文件上传（256M, 2G）
7. **流式响应**: 需要确认平台是否支持 chunked transfer encoding
8. **选择路由方式**: 
   - 简单路由使用 `application.routes` 配置（推荐）
   - 复杂路由需求使用自定义 nginx 配置替换

## 十、环境变量详细分析

### 环境变量分类

#### 1. 服务间通信 URL（使用服务名）

这些 URL 用于容器之间的通信，使用 Docker 服务名：

```yaml
# appflowy 服务
APPFLOWY_GOTRUE_BASE_URL=http://gotrue:9999          # 服务间通信
APPFLOWY_WEB_URL=http://web:80                        # 服务间通信
APPFLOWY_S3_MINIO_URL=http://minio:9000              # 服务间通信
AI_SERVER_HOST=ai                                     # 服务名
AI_SERVER_PORT=5001                                   # 端口

# gotrue 服务
DATABASE_URL=postgres://postgres:123456@timescaledb:5432/postgres?search_path=auth

# worker 服务
APPFLOWY_WORKER_REDIS_URL=redis://redis:6379
APPFLOWY_WORKER_DATABASE_URL=postgres://postgres:123456@timescaledb:5432/postgres
APPFLOWY_S3_MINIO_URL=http://minio:9000

# ai 服务
AI_DATABASE_URL=postgres://postgres:123456@timescaledb:5432/postgres
AI_REDIS_URL=redis://redis:6379
AI_MINIO_URL=http://minio:9000
```

**特点**:
- 使用服务名（如 `gotrue`, `timescaledb`, `redis`）
- 不包含域名，直接使用服务名和端口
- 这些 URL 只在容器网络内部使用

#### 2. 外部访问 URL（使用完整域名）

这些 URL 用于客户端访问，使用完整的域名：

```yaml
# appflowy 服务
APPFLOWY_BASE_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp

# gotrue 服务
API_EXTERNAL_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp/gotrue

# web 服务
APPFLOWY_BASE_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp
APPFLOWY_GOTRUE_BASE_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp/gotrue
APPFLOWY_WS_BASE_URL=ws://appflowy.ink.akawa.ety001.appflowy.lzcapp/ws/v2

# ai 服务
AI_APPFLOWY_HOST=http://appflowy.ink.akawa.ety001.appflowy.lzcapp

# minio 服务
MINIO_BROWSER_REDIRECT_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp/minio
```

**特点**:
- 使用完整域名：`appflowy.ink.akawa.ety001.appflowy.lzcapp`
- 包含协议（http:// 或 ws://）
- 这些 URL 用于客户端（浏览器、移动应用）访问

#### 3. 域名格式分析

懒猫平台的域名格式：
```
<subdomain>.<namespace>.<package>.lzcapp
```

对于 AppFlowy:
- `subdomain`: `appflowy` (在 application.subdomain 中定义)
- `namespace`: `ink.akawa.ety001`
- `package`: `appflowy` (在 package 字段中定义)
- 完整域名: `appflowy.ink.akawa.ety001.appflowy.lzcapp`

#### 4. 环境变量转换模式

**原始配置模式**（使用环境变量）:
```yaml
APPFLOWY_BASE_URL=${APPFLOWY_BASE_URL}
APPFLOWY_GOTRUE_BASE_URL=${APPFLOWY_GOTRUE_BASE_URL}
```

**移植后模式**（硬编码）:
```yaml
# 服务间通信
APPFLOWY_GOTRUE_BASE_URL=http://gotrue:9999

# 外部访问
APPFLOWY_BASE_URL=http://appflowy.ink.akawa.ety001.appflowy.lzcapp
```

**改进建议**（使用懒猫平台变量）:
```yaml
# 可以使用平台提供的变量
APPFLOWY_BASE_URL=http://${LAZYCAT_APP_DOMAIN}
APPFLOWY_GOTRUE_BASE_URL=http://${LAZYCAT_APP_DOMAIN}/gotrue
```

#### 5. WebSocket URL 配置

**web 服务中的配置**:
```yaml
APPFLOWY_WS_BASE_URL=ws://appflowy.ink.akawa.ety001.appflowy.lzcapp/ws/v2
```

**说明**:
- 使用 `ws://` 协议（非加密 WebSocket）
- 路径为 `/ws/v2`
- 使用完整域名
- 注意：nginx 中配置的是 `/ws`，但这里使用 `/ws/v2`，可能需要确认实际路径

#### 6. 数据库连接字符串

**格式**: `postgres://user:password@host:port/database?params`

**示例**:
```yaml
APPFLOWY_DATABASE_URL=postgres://postgres:123456@timescaledb:5432/postgres
DATABASE_URL=postgres://postgres:123456@timescaledb:5432/postgres?search_path=auth
```

**关键点**:
- 用户名: `postgres`
- 密码: `123456` (硬编码，安全性问题)
- 主机: `timescaledb` (服务名)
- 端口: `5432`
- 数据库: `postgres`
- 额外参数: `?search_path=auth` (gotrue 使用)

#### 7. Redis 连接字符串

**格式**: `redis://host:port`

**示例**:
```yaml
APPFLOWY_REDIS_URI=redis://redis:6379
APPFLOWY_WORKER_REDIS_URL=redis://redis:6379
AI_REDIS_URL=redis://redis:6379
```

**关键点**:
- 使用服务名 `redis`
- 默认端口 `6379`
- 无密码配置（可能不安全）

## 十一、移植最佳实践总结

### 1. 服务识别和简化
- 识别核心服务（必须保留）和辅助服务（可选）
- 移除平台提供的服务（如 nginx）
- 简化服务名称（去掉前缀）

### 2. 路由配置
- 理解 `application` 项是特殊的 nginx 容器
- 优先使用 `application.routes` 配置（简单直接）
- 对于根路径，使用 `/=service:80` 格式
- 懒猫平台有自签名服务，只需要关注 80 端口
- 复杂路由需求才考虑自定义 nginx 配置替换
- 注意路径前缀的处理（通常不需要显式重写）
- 确保 WebSocket 路由正确配置

### 3. 环境变量处理
- 服务间通信使用服务名（如 `service:port`）
- 外部访问使用完整域名（如 `app.xxx.lzcapp`）
- 使用懒猫平台提供的环境变量（如 `${LAZYCAT_APP_DOMAIN}`）

### 4. 数据持久化
- named volumes 转换为 bind mounts
- **必须**使用 `/lzcapp/var/` 作为数据目录前缀
- 按服务区分路径：`/lzcapp/var/服务名`
- 多路径持久化：`/lzcapp/var/容器名_服务名`

### 5. 健康检查
- 保留关键服务的健康检查
- 使用 `CMD-SHELL` 格式
- 配置适当的 `start_period`

### 6. 依赖关系
- 保留服务间的依赖关系
- 确保启动顺序正确

